(function(){var g=YAHOO.util.Dom,l=YAHOO.util.Event,c=YAHOO.util.Element;Alfresco.UserProfile=function(p){Alfresco.UserProfile.superclass.constructor.call(this,"Alfresco.UserProfile",p,["button"]);return this};YAHOO.extend(Alfresco.UserProfile,Alfresco.component.Base,{options:{userId:"",profile:{}},fileUpload:null,onReady:function a(){if(this.options.profile.isEditable){this.widgets.upload=Alfresco.util.createYUIButton(this,"button-upload",this.onUpload);this.widgets.signUpload=Alfresco.util.createYUIButton(this,"sign-upload",this.onSignUpload);this.widgets.clearphoto=Alfresco.util.createYUIButton(this,"button-clearphoto",this.onClearPhoto);this.widgets.clearESign=Alfresco.util.createYUIButton(this,"button-clear-esign",this.onClearESign);this.widgets.edit=Alfresco.util.createYUIButton(this,"button-edit",this.onEditProfile);this.widgets.save=Alfresco.util.createYUIButton(this,"button-save",null,{type:"submit",additionalClass:"alf-primary-button"});this.widgets.cancel=Alfresco.util.createYUIButton(this,"button-cancel",this.onCancel);var p=new Alfresco.forms.Form(this.id+"-form");this.widgets.form=p;p.setSubmitElements(this.widgets.save);p.setSubmitAsJSON(true);p.setAJAXSubmit(true,{successCallback:{fn:this.onSuccess,scope:this}});p.addValidation(this.id+"-input-firstName",Alfresco.forms.validation.mandatory,null,"keyup");p.addValidation(this.id+"-input-email",Alfresco.forms.validation.mandatory,null,"keyup");p.addValidation(this.id+"-input-email",Alfresco.forms.validation.email,null,"keyup");p.addValidation(this.id+"-input-companyemail",Alfresco.forms.validation.email,null,"keyup");p.addValidation(this.id+"-input-telephone",Alfresco.forms.validation.phone,null,"keyup");p.addValidation(this.id+"-input-mobile",Alfresco.forms.validation.phone,null,"keyup");p.addValidation(this.id+"-input-companytelephone",Alfresco.forms.validation.phone,null,"keyup");p.addValidation(this.id+"-input-companyfax",Alfresco.forms.validation.phone,null,"keyup");p.init()}if(this.options.profile.isEditable&&window.location.hash=="#edit"){this.onEditProfile()}else{g.removeClass(this.id+"-readview","hidden")}this.widgets.following=Alfresco.util.createYUIButton(this,"button-following",this.onFollowing)},onEditProfile:function o(s,t){g.addClass(this.id+"-readview","hidden");var r=this.options.profile,q=this.id+"-input-";g.get(q+"lastName").value=r.lastName;g.get(q+"firstName").value=r.firstName;g.get(q+"jobtitle").value=r.jobtitle;g.get(q+"location").value=r.location;g.get(q+"bio").value=r.bio;g.get(q+"telephone").value=r.telephone;g.get(q+"mobile").value=r.mobile;g.get(q+"email").value=r.email;g.get(q+"skype").value=r.skype;g.get(q+"instantmsg").value=r.instantmsg;g.get(q+"googleusername").value=r.googleusername;g.get(q+"organization").value=r.organization;g.get(q+"companyaddress1").value=r.companyaddress1;g.get(q+"companyaddress2").value=r.companyaddress2;g.get(q+"companyaddress3").value=r.companyaddress3;g.get(q+"companypostcode").value=r.companypostcode;g.get(q+"companytelephone").value=r.companytelephone;g.get(q+"companyfax").value=r.companyfax;g.get(q+"companyemail").value=r.companyemail;this.widgets.form.validate();g.removeClass(this.id+"-editview","hidden")},onUpload:function k(q,r){if(this.fileUpload===null){this.fileUpload=Alfresco.getFileUploadInstance()}var p={flashUploadURL:"slingshot/profile/uploadavatar",htmlUploadURL:"slingshot/profile/uploadavatar.html",username:this.options.userId,mode:this.fileUpload.MODE_SINGLE_UPLOAD,onFileUploadComplete:{fn:this.onFileUploadComplete,scope:this}};this.fileUpload.show(p);l.preventDefault(q)},onSignUpload:function e(q,r){if(this.fileUpload===null){this.fileUpload=Alfresco.getFileUploadInstance()}var p={flashUploadURL:"slingshot/profile/uploadesign",htmlUploadURL:"slingshot/profile/uploadesign.html",username:this.options.userId,mode:this.fileUpload.MODE_SINGLE_UPLOAD,onFileUploadComplete:{fn:this.onSignUploadComplete,scope:this}};this.fileUpload.show(p);l.preventDefault(q)},onClearPhoto:function d(p,q){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"slingshot/profile/resetavatar/"+encodeURIComponent(this.options.userId),method:Alfresco.util.Ajax.PUT,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(r){var s=g.getElementsByClassName("photoimg","img");for(i in s){s[i].src=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png"}},scope:this}})},onClearESign:function n(p,q){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"slingshot/profile/resetesign/"+encodeURIComponent(this.options.userId),method:Alfresco.util.Ajax.PUT,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(r){var s=g.getElementsByClassName("signImg","img");for(i in s){s[i].src=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png"}},scope:this}})},onFileUploadComplete:function f(p){var t=p.successful.length;if(t>0){var s=p.successful[0].nodeRef;var u=g.getElementsByClassName("photoimg","img");for(i in u){u[i].src=Alfresco.constants.PROXY_URI+"api/node/"+s.replace("://","/")+"/content/thumbnails/avatar?c=force"}var r={};r[this.id+"-photoref"]=s;var q={method:"POST",url:g.get(this.id+"-form").attributes.action.nodeValue,dataObj:r};Alfresco.util.Ajax.jsonRequest(q)}},onSignUploadComplete:function m(p){var t=p.successful.length;if(t>0){var s=p.successful[0].nodeRef;var u=g.getElementsByClassName("signImg","img");for(i in u){u[i].src=Alfresco.constants.PROXY_URI+"api/node/"+s.replace("://","/")+"/content/thumbnails/esign?c=force"}var r={};r[this.id+"-photoref1"]=s;var q={method:"POST",url:g.get(this.id+"-form").attributes.action.nodeValue,dataObj:r};Alfresco.util.Ajax.jsonRequest(q)}},onSuccess:function b(p){if(p){if(window.location.hash=="#edit"){window.location=window.location.href.replace(/#.*/,"")}else{location.reload(true)}}else{Alfresco.util.PopupManager.displayPrompt({text:Alfresco.util.message("message.failure",this.name)})}},onCancel:function j(p,q){g.addClass(this.id+"-editview","hidden");g.removeClass(this.id+"-readview","hidden")},onFollowing:function h(q,r){var p="/api/subscriptions/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/"+(this.options.follows?"unfollow":"follow");Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+p,dataObj:[this.options.profile.name],successCallback:{fn:function(){window.location.reload()},scope:this}})}})})();